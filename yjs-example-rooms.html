<!DOCTYPE html>
<html>
<head>
    <title>Y.js Collaborative Editor - Multiple Rooms</title>
    <script type="module">
        import * as Y from 'https://cdn.jsdelivr.net/npm/yjs@13.6.8/dist/yjs.mjs';
        import { CodemirrorBinding } from 'https://cdn.jsdelivr.net/npm/y-codemirror@3.0.1/dist/y-codemirror.mjs';
        window.Y = Y;
        window.CodemirrorBinding = CodemirrorBinding;
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .container {
            display: grid;
            grid-template-columns: 250px 1fr;
            gap: 20px;
        }
        .sidebar {
            padding: 15px;
            background: #f8f8f8;
            border-radius: 5px;
        }
        .room-list {
            margin-top: 10px;
        }
        .room-item {
            padding: 8px;
            margin: 5px 0;
            background: white;
            border-radius: 3px;
            cursor: pointer;
        }
        .room-item:hover {
            background: #eee;
        }
        .room-item.active {
            background: #e0e0e0;
        }
        .editor-container {
            border: 1px solid #ccc;
            padding: 15px;
            border-radius: 5px;
        }
        .status {
            margin-top: 10px;
            padding: 10px;
            background: #f8f8f8;
            border-radius: 3px;
        }
        .CodeMirror {
            height: 400px;
            border: 1px solid #ddd;
        }
        .awareness-list {
            margin-top: 10px;
            padding: 10px;
            background: #f0f0f0;
        }
        .user-cursor {
            padding: 2px 5px;
            margin: 2px;
            border-radius: 3px;
            display: inline-block;
        }
        .create-room {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <h1>Y.js Collaborative Editor - Multiple Rooms</h1>
    <div class="container">
        <div class="sidebar">
            <h2>Rooms</h2>
            <button class="create-room" onclick="createNewRoom()">Create New Room</button>
            <div class="room-list" id="room-list">
                Loading rooms...
            </div>
        </div>
        <div class="editor-container">
            <h2>Room: <span id="current-room">Not connected</span></h2>
            <div id="editor"></div>
            <div class="status" id="connection-status">Connecting...</div>
            <div class="awareness-list" id="awareness-list">Users online: </div>
        </div>
    </div>

    <script type="module">
        // Wait for Y to be available
        setTimeout(async () => {
            const Y = window.Y;
            const CodemirrorBinding = window.CodemirrorBinding;
            
            if (!Y || !CodemirrorBinding) {
                console.error('Y.js or CodemirrorBinding not loaded');
                return;
            }

            let currentRoomId = null;
            let currentProvider = null;
            let currentDoc = null;
            let currentBinding = null;

            // Initialize CodeMirror
            const editor = CodeMirror(document.getElementById('editor'), {
                mode: 'text/plain',
                lineNumbers: true,
                theme: 'default',
                lineWrapping: true
            });

            // Create custom signaling provider
            class CustomSignalingProvider {
                constructor(ydoc, roomId) {
                    this.ydoc = ydoc;
                    this.roomId = roomId;
                    this.ws = null;
                    this.peers = new Set();
                    this.awareness = new Y.Awareness(ydoc);
                    this.connect();

                    // Set up awareness
                    this.awareness.setLocalState({
                        user: {
                            name: 'User ' + ydoc.clientID,
                            color: userColor
                        }
                    });
                }

                connect() {
                    this.ws = new WebSocket('ws://127.0.0.1:8081');
                    
                    this.ws.onopen = () => {
                        updateStatus('Connected to signaling server');
                        // Send join message
                        this.ws.send(JSON.stringify({ 
                            type: 'Join',
                            payload: {
                                user_id: this.ydoc.clientID,
                                user_color: userColor,
                                room_id: this.roomId
                            }
                        }));

                        // Request room list
                        this.ws.send(JSON.stringify({ type: 'GetRooms' }));
                    };

                    this.ws.onmessage = (event) => {
                        const message = JSON.parse(event.data);
                        this.handleSignalingMessage(message);
                    };

                    this.ws.onerror = (error) => {
                        updateStatus('Signaling server error: ' + error.message);
                    };

                    this.ws.onclose = () => {
                        updateStatus('Disconnected from signaling server');
                        // Attempt to reconnect after 5 seconds
                        setTimeout(() => this.connect(), 5000);
                    };
                }

                send(message) {
                    if (this.ws && this.ws.readyState === WebSocket.OPEN) {
                        this.ws.send(JSON.stringify(message));
                    }
                }

                async handleSignalingMessage(message) {
                    switch (message.type) {
                        case 'Join':
                            if (message.payload.room_id === this.roomId && 
                                message.payload.user_id !== this.ydoc.clientID) {
                                this.peers.add(message.payload.user_id);
                                updateAwarenessList();
                            }
                            break;
                        case 'SyncUpdate':
                            if (message.payload.room_id === this.roomId) {
                                Y.applyUpdate(this.ydoc, new Uint8Array(message.payload.update));
                            }
                            break;
                        case 'RoomList':
                            updateRoomList(message.payload.rooms);
                            break;
                    }
                }

                disconnect() {
                    if (this.ws) {
                        this.ws.send(JSON.stringify({
                            type: 'LeaveRoom',
                            payload: { room_id: this.roomId }
                        }));
                        this.ws.close();
                    }
                }
            }

            // Create a random color for this user
            const userColor = '#' + Math.floor(Math.random()*16777215).toString(16);

            function updateStatus(message) {
                document.getElementById('connection-status').textContent = message;
            }

            function updateAwarenessList() {
                if (!currentProvider) return;
                
                const list = document.getElementById('awareness-list');
                list.innerHTML = 'Users online: ' + currentProvider.peers.size;
                currentProvider.peers.forEach(peerId => {
                    const userElement = document.createElement('span');
                    userElement.className = 'user-cursor';
                    userElement.style.backgroundColor = userColor;
                    userElement.textContent = `User ${peerId}`;
                    list.appendChild(userElement);
                });
            }

            function updateRoomList(rooms) {
                const list = document.getElementById('room-list');
                list.innerHTML = '';
                
                rooms.forEach(room => {
                    const roomElement = document.createElement('div');
                    roomElement.className = 'room-item' + (room.room_id === currentRoomId ? ' active' : '');
                    roomElement.textContent = `Room ${room.room_id} (${room.peer_count} users)`;
                    roomElement.onclick = () => joinRoom(room.room_id);
                    list.appendChild(roomElement);
                });
            }

            window.createNewRoom = () => {
                const roomId = 'room-' + Math.random().toString(36).substr(2, 9);
                joinRoom(roomId);
            };

            async function joinRoom(roomId) {
                // Clean up previous room
                if (currentProvider) {
                    currentProvider.disconnect();
                    currentDoc.destroy();
                }

                // Set up new room
                currentRoomId = roomId;
                document.getElementById('current-room').textContent = roomId;

                // Initialize new Yjs document
                currentDoc = new Y.Doc();
                const ytext = currentDoc.getText('codemirror');

                // Initialize new provider
                currentProvider = new CustomSignalingProvider(currentDoc, roomId);

                // Bind CodeMirror to Yjs
                if (currentBinding) {
                    currentBinding.destroy();
                }
                currentBinding = new CodemirrorBinding(ytext, editor, currentProvider.awareness);

                // Listen for Yjs updates
                currentDoc.on('update', (update) => {
                    currentProvider.send({
                        type: 'SyncUpdate',
                        payload: {
                            update: Array.from(update),
                            room_id: roomId
                        }
                    });
                });

                updateStatus('Connected to room: ' + roomId);
            }

            // Clean up on page unload
            window.addEventListener('unload', () => {
                if (currentProvider) {
                    currentProvider.disconnect();
                    currentDoc.destroy();
                }
            });

            // Create or join default room
            joinRoom('default-room');
        }, 1000); // Wait 1 second for modules to load
    </script>
</body>
</html>
